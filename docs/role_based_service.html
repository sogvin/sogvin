<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="theme.css"/>
<link rel="stylesheet" type="text/css" href="a4.css"/>
<title>Role based service - Software Engineering</title>
</head>
<body>
<header><code>Design - <a href="index.html">Software Engineering</a></code></header>
<article>
<h1>Role based service</h1>
<p>Servers provide a service through some protocol, often the
	protocol is HTTP. Services like this are often sizeable
	applications and without a design they become hard to maintain
	over time. Moreover services and their features need protecting
	from unauthorized access. One approach is to provide role based
	access design.</p>
<h2>Navigating the stars</h2>
<p>Before we go into the design, let me tell you a bit about the
    business of navigating through the galaxy. By describing the
    domain we'll be able to elicit concepts and features for our
    system design.</p>
<p>The company <b>Future Inc.</b> provides people means to travel
    the Milky Way. Customers, browse and order trips on <code>galaxytravel.future.now</code>. Destinations are cataloged and
    presented adventurously with specifications of distance, travel
    time, ship details as well as a captains profile.<br/>Captains submit a flight plan just days before departure to
	make sure it's as accurate as possible since space travel is not
	an exact science and there are lot of unknown objects
	about. Luckily the navigation system provides them with all the
	information they need. Once the plan has been submitted,
	passengers can view route details, including interesting
	waypoints. Crew members can also access the details of routes and
	possible alternatives, should there be an unforseen cosmic event.</p>
<h3>Elicitation</h3>
<p>We have enough information to get started I think. The main
	domain concepts are</p>
<ul>
<li>navigating the stars - the domain</li>
<li>galaxytravel.future.com - service</li>
</ul>
<p>Focusing on the navigation part there are people(users) using
	the system with the following roles</p>
<ul>
<li>captain</li>
<li>passenger</li>
<li>crew member</li>
</ul>
<p>The system provides features to manipulate resources</p>
<ul>
<li>catalog, destination</li>
<li>ship</li>
<li>flight plan, route, waypoint</li>
</ul>
<div class="sidenote" style="margin-top: 2cm"><div class="inner">Use different nam- es for package, commands and DNS.</div>
</div>
<p>This service will be hosted on <code>galaxytravel.future.now</code>. The domain logic is <em>spaceflight</em> i.e. the package name. We'll name the
    application providing this service via HTTP, <em>htspace</em>.<br/>Don't name the application the same as the domain
    logic package. Also refrain from naming it same as the DNS name
    where it's hosted. The DNS will remain for a long time whereas
    your system will evolve, be split up into smaller applications
    with specific responsibilities. The domain logic however will
    probably remain the same. The directory layout looks like this</p>
<pre class="command"><code>$ tree spaceflight
spaceflight
├── cmd
│   └── htspace
│       ├── application.go
│       └── htspace
│           └── main.go
├── package.go
├── resource.go
├── role.go
└── system.go

3 directories, 6 files
</code></pre><p>The system is the most prominent abstraction the spaceflight
	package provides. It's responsible for synchronizing database
	access and other domain related configuration. There would usually
	only exist one instance of the system.</p>
<div class="filename">spaceflight/system.go</div>
<pre class="srcfile complete"><code class="go">package spaceflight

func NewSystem() *System {
	return &System{}
}

// System provides logic for reading and writing spaceflight related
// resources.
type System struct {
	// e.g. database, sync mutexes
}
</code></pre><p>Roles expose access to user methods. Fairly often we talk about
	what we can do with a system, referring to you and me as
	users.</p>
<em>- Pilots plan routes</em><br/><em>- Passengers and pilots view routes</em><p>This translates to PlanRoute is implemented by type user and
	accessible via the pilot role. Also ListRoutes is implemented by
	type user but accessible by both roles pilot and passenger.</p>
<div class="figure"><svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="395" height="334">
<path stroke="black" stroke-dasharray="5,5,5" d="M272,174 L225,104" />
<g transform="rotate(236 225 104)"><path stroke="black" fill="#ffffff" d="M225,104 l-8,-4 l 0,8 Z" /></g>

<path stroke="black" stroke-dasharray="5,5,5" d="M122,174 L169,104" />
<g transform="rotate(-56 169 104)"><path stroke="black" fill="#ffffff" d="M169,104 l-8,-4 l 0,8 Z" /></g>

<rect stroke="#d3d3d3" fill="#ffffff" x="120" y="20" width="154" height="84"/>
<line stroke="#d3d3d3" x1="120" y1="46" x2="274" y2="46"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="62">ListRoutes()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="78">PlanRoute()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="94">setUser()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="36">spaceflight.Role interface</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="20" y="174" width="134" height="106"/>
<line stroke="#d3d3d3" x1="20" y1="200" x2="154" y2="200"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="216">User</text>
<line stroke="#d3d3d3" x1="20" y1="222" x2="154" y2="222"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="238">ListRoutes()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="254">PlanRoute()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="270">Use()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="190">spaceflight.Pilot struct</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="224" y="174" width="169" height="106"/>
<line stroke="#d3d3d3" x1="224" y1="200" x2="393" y2="200"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="216">User</text>
<line stroke="#d3d3d3" x1="224" y1="222" x2="393" y2="222"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="238">ListRoutes()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="254">PlanRoute()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="270">Use()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="190">spaceflight.Passenger struct</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="78" y="327">Different roles provide
		different methods</text></svg></div>
<div class="filename">spaceflight/role.go</div>
<pre class="srcfile complete"><code class="go">package spaceflight

type Role interface {
	setUser(v *User)
	PlanRoute(route Route) error
	ListRoutes() ([]Route, error)
}

type Pilot struct{ *User }

func (me *Pilot) setUser(v *User) { me.User = v }

func (me *Pilot) PlanRoute(v Route) error      { return me.planRoute(v) }
func (me *Pilot) ListRoutes() ([]Route, error) { return me.listRoutes() }

// ----------------------------------------

type Passenger struct{ *User }

func (me *Passenger) setUser(v *User) { me.User = v }

func (me *Passenger) PlanRoute(v Route) error      { return ErrUnauthorized }
func (me *Passenger) ListRoutes() ([]Route, error) { return me.listRoutes() }

// ----------------------------------------

// User implements domain logic for operations on the System and
// should be used through a role.
type User struct {
	sys *System
}

func (me *User) Use(v *System, role Role) Role {
	me.sys = v
	role.setUser(me)
	return role
}

func (me *User) planRoute(route Route) error {
	// implement...
	return nil
}

func (me *User) listRoutes() ([]Route, error) {
	// implement list routes
	return nil, nil
}
</code></pre><p>This design provides well defined places to implement future
	features. Assume the spaceflight service should provide planet
	information to users.</p>
<ol>
<li>Define resource Planet</li>
<li>Implement read write methods on type user, e.g.<ul>
<li><code>viewPlanet(name string)</code></li>
<li><code>savePlanet(v Planet) error</code></li>
</ul>
</li>
<li>Expose user methods to selected roles</li>
</ol>
<p>Once you need authentication you have the option to make it
	part of this service, by extending the Service.Use() method with
	e.g. credentials argument.</p>
<h2>HTTP interface</h2>
<p>The application htspace can now expose the spaceflight features
	using its system and roles. An application provides methods for
	accessing resources via different URLs. The routing of a url to a
	specific server method is handled by the subsequent router.</p>
<div class="filename">htspace/application.go</div>
<pre class="srcfile complete"><code class="go">// Package htspace exposes the spaceflight system via HTTP.
package htspace

import (
	"encoding/json"
	"net/http"

	"github.com/gregoryv/spaceflight"
)

func NewApplication(sys *spaceflight.System) *Application {
	return &Application{sys: sys}
}

type Application struct {
	sys *spaceflight.System
}

// Router returns a router providing HTTP access to the spaceflight
// system.
func (me *Application) Router() *http.ServeMux {
	m := http.NewServeMux()
	m.HandleFunc("/routes", me.serveRoutes)
	return m
}

func (me *Application) serveRoutes(w http.ResponseWriter, r *http.Request) {
	// Default to the passenger role
	var user spaceflight.User
	role := user.Use(me.sys, getRole(r))

	routes, _ := role.ListRoutes()
	json.NewEncoder(w).Encode(routes)
}

func getRole(r *http.Request) spaceflight.Role {
	switch r.URL.Query().Get("role") {
	case "pilot":
		return &spaceflight.Pilot{}
	default:
		return &spaceflight.Passenger{}
	}
}
</code></pre><p>A request from a client such as a browser would follow the
	below sequence.</p>
<svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="645" height="296">
<rect stroke="black" stroke-width="0" fill="#99e6ff" fill-opacity="0.1" x="312" y="24" width="280" height="218"/>
<text class="area-blue-title" font-size="12px" x="318" y="42"></text>
<line stroke="#d3d3d3" x1="32" y1="24" x2="32" y2="200"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="10" y="18">browser</text>
<line stroke="#d3d3d3" x1="172" y1="24" x2="172" y2="200"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="143" y="18">http.Server</text>
<line stroke="#d3d3d3" x1="312" y1="24" x2="312" y2="200"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="259" y="18">htspace.Application</text>
<line stroke="#d3d3d3" x1="452" y1="24" x2="452" y2="200"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="408" y="18">spaceflight.Role</text>
<line stroke="#d3d3d3" x1="592" y1="24" x2="592" y2="200"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="541" y="18">spaceflight.System</text>
<text font-style="italic" font-family="Arial,Helvetica,sans-serif" font-size="12px" x="357" y="235">Role based access to domain logic</text>
<path stroke="black" d="M32,57 L172,57" />
<g transform="rotate(0 172 57)"><path stroke="black" fill="#ffffff" d="M172,57 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="70" y="54">GET /routes</text>
<path stroke="black" d="M172,90 L312,90" />
<g transform="rotate(0 312 90)"><path stroke="black" fill="#ffffff" d="M312,90 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="203" y="87">serveRoutes()</text>
<path stroke="black" d="M312,123 L452,123" />
<g transform="rotate(0 452 123)"><path stroke="black" fill="#ffffff" d="M452,123 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="357" y="120">new: role</text>
<path stroke="black" d="M312,156 L592,156" />
<g transform="rotate(0 592 156)"><path stroke="black" fill="#ffffff" d="M592,156 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="407" y="153">role.ListRoutes()</text>
<path stroke="black" d="M312,189 L32,189" />
<g transform="rotate(180 32 189)"><path stroke="black" fill="#ffffff" d="M32,189 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="121" y="186">write http response</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="198" y="289">Using spaceflight system via a HTTP interface</text></svg><p>Separating the domain logic from the application exposing it
	using some protocol allows your service to grow. Naming components
	carefully we can reason about concepts such as the-galaxytravel-service,
	spaceflight-system and htspace-application, which are all
	easily referencable in the source code aswell.</p>
</article>
<footer>Gregory Vin&ccaron;i&cacute;</footer></body>
</html>
