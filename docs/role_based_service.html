<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="theme.css"/>
<link rel="stylesheet" type="text/css" href="a4.css"/>
<title>Role based service - Software Engineering</title>
</head>
<body>
<header><code>Design - <a href="index.html">Software Engineering</a></code></header>
<article>
<h1>Role based service</h1>
<p>This article proposes a design for services that need role
	based access control. Services running on cloud servers mostly
	provide API's through the HTTP protocol and are often sizeable
	applications. Without a clear design they become hard to maintain
	over time. Moreover their features need protecting from
	unauthorized access. This protection can be defined in roles.
	I'll explore one such design and elaborate on the naming with an
	example service for navigating the stars.</p>
<h2>Navigating the stars</h2>
<br/><p>Before we go into the design, let me tell you about the
    business of navigating through the galaxy. By describing the
    domain we'll be able to elicit concepts and features for our
    system design.</p>
<div class="figure"><img src="img/galaxytravel.png"/></div>
<p>The company <b>Future Inc.</b> provides people means to travel
	the Milky Way. Customers, browse and order trips on <code>galaxytravel.future.now</code>. Destinations are cataloged and
	presented adventurously with specifications of distance, travel
	time, ship details as well as a captains profile.<br/>The
	ships captain uses the same service to plan the entire flight. He
	submits a flight plan just days before departure to make sure it's
	as accurate as possible since space travel is not an exact science
	and there are lot of unknown objects about. Luckily the navigation
	system provides the pilots with all the information they
	need. Once the plan has been submitted, passengers can view route
	details, including interesting waypoints. Crew members also access
	the details of routes and possible alternatives, should there be
	an unforseen cosmic event.</p>
<p>Now that we know a bit about the domain we'll be working in,
	lets find the important concepts and focus on the ones part of
	navigating the stars.</p>
<h3>Elicitation</h3>
<p>We know the service is found at galaxytravel.future.com. This
	is a domain name selected because it sounds great and is easily
	remembered by customers when they want to elope to another part of
	the galaxy, think Luke Skywalker in a bar. It has very little to
	do with navigating the stars though so we should exclude that name
	or part of it in our design.</p>
<p>Several people are interacting with the service; customers,
	captain, crew members and passengers. Let's exclude the customer
	as that is a role more related to booking. This leaves us
	passenger, captain and crew members. Obviously the passenger is a
	customer at some point but the word customer is irrelevant when it
	comes to navigating the stars. A passenger however does have
	access to view parts of the flight plan, which leads us to
	enumerating the features of our navigation service.</p>
<p>We recognize that the galaxytravel service, serves both
	customers and captains though with different purpose. In our
	design we'll separate these into different systems and focus on
	the system that provides features for maninpulating
	flightplans. The captain submits a flightplan whereas, other crew
	members and passengers can view it. Passengers can see the
	designated route, with details such as current location, waypoints
	and estimated time of arrival.</p>
<p>Let's summarize by grouping the concepts</p>
<dl>
<dt>Role</dt>
<dd>passenger, captain, crew member</dd>
<dt>Rsource</dt>
<dd>flightplan, route, waypoint</dd>
<dt>Feature</dt>
<dd>submit flightplan, view flightplan</dd>
</dl><p>Note that up until now all the terminology is from the domain
	of navigating the stars. The only term used that somehow relates
	to a software is "system". Which we'll design now.</p>
<h2>System design</h2>
<p>You can view the full code <a href="https:/github.com/gregoryv/navstar">here</a>.</p>
<h3>Package naming</h3>
<p>The first thing we need is a name for the package or module
	that will contain the source code of our software. One way to
	figure out a good name is to try to write that one line package
	documentation sentence. <em>"Package X provides ..."</em></p>
<em>"Package galaxytravel provides applications for planning star
	navigation"</em><p>Sounds ok, but wait, we said that the service name galaxytravel
	was selected for customers and should be excluded from the
	navigation system. Also it as a service provides more than just
	applications for planning star navigation. How about</p>
<em>"Package starnavigation provides means to plan galaxy flights"</em><p>Short sentence which abstracts what it provides by using the
	word "means" and is more specific by using "plan galaxy
	flights". One problem though, the name "starnavigation" is a
	mouthful, with five syllables. The name will be used extensively
	and we should try to find something shorter. Maybe</p>
<div class="sidenote" style="margin-top: 0cm"><div class="inner">Short pronounce- able package name</div>
</div>
<em>"Package navstar provides a system for planning galaxy flights"</em><p>Short pronouncable name, mentions the system and its main
	purpose. It allows for easy discussion and ties into the domain
	terminology nicely. Let's stick with it for now.</p>
<h3>Navstar package</h3>
<div class="figure"><svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="313" height="224">
<path stroke="#d3d3d3" fill="#ffffff" d="M100,120 l 40,0 20,25 -20,25 -40,0 -20,-25 20,-25" />
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="100" y="149">navstar</text>
<path stroke="#d3d3d3" fill="#e2e2e2" d="M164,93 l 40,0 20,25 -20,25 -40,0 -20,-25 20,-25" />
<text class="dim-title" font-size="12px" x="184" y="122"></text>
<path stroke="#d3d3d3" fill="#e2e2e2" d="M100,66 l 40,0 20,25 -20,25 -40,0 -20,-25 20,-25" />
<text class="dim-title" font-size="12px" x="120" y="95"></text>
<path stroke="#d3d3d3" fill="#e2e2e2" d="M164,39 l 40,0 20,25 -20,25 -40,0 -20,-25 20,-25" />
<text class="dim-title" font-size="12px" x="184" y="68"></text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="0" y="217">Navstar package is the core
	package with domain logic</text></svg></div>
<p>The type system is the most prominent abstraction the navstar
	package provides. It's responsible for synchronizing database
	access and other domain related configuration. There would usually
	only exist one instance of the system.</p>
<div class="filename"><a href="https:/github.com/gregoryv/navstar/blob/main/system.go">navstar/system.go</a></div>
<pre class="srcfile complete"><code class="go">package navstar

func NewSystem() *System {
	return &System{}
}

// System provides logic for reading and writing navstar related
// resources.
type System struct {
	// e.g. database, sync mutexes
}
</code></pre><p>Roles expose access to user methods. Fairly often we talk about
	what we can do with a system, referring to you and me as
	users.</p>
<em>- Pilots submit flightplan</em><br/><em>- Passengers and crew member view flightplans</em><p>This translates to SubmitFlightplan is implemented by type user
	and accessible via the pilot role. Also ViewFlightplan is
	implemented by type user but accessible by roles pilot, passenger
	and crew member.</p>
<div class="figure"><svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="528" height="334">
<path stroke="black" stroke-dasharray="5,5,5" d="M406,179 L312,104" />
<g transform="rotate(218 312 104)"><path stroke="black" fill="#ffffff" d="M312,104 l-8,-4 l 0,8 Z" /></g>

<path stroke="black" stroke-dasharray="5,5,5" d="M260,174 L260,104" />
<g transform="rotate(-90 260 104)"><path stroke="black" fill="#ffffff" d="M260,104 l-8,-4 l 0,8 Z" /></g>

<path stroke="black" stroke-dasharray="5,5,5" d="M116,179 L208,104" />
<g transform="rotate(-39 208 104)"><path stroke="black" fill="#ffffff" d="M208,104 l-8,-4 l 0,8 Z" /></g>

<rect stroke="#d3d3d3" fill="#ffffff" x="193" y="20" width="135" height="84"/>
<line stroke="#d3d3d3" x1="193" y1="46" x2="328" y2="46"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="199" y="62">ListFlightplans()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="199" y="78">SubmitFlightplan()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="199" y="94">setUser()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="199" y="36">navstar.Role interface</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="0" y="174" width="116" height="106"/>
<line stroke="#d3d3d3" x1="0" y1="200" x2="116" y2="200"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="6" y="216">User</text>
<line stroke="#d3d3d3" x1="0" y1="222" x2="116" y2="222"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="6" y="238">ListFlightplans()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="6" y="254">SubmitFlightplan()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="6" y="270">Use()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="6" y="190">navstar.Pilot struct</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="186" y="174" width="150" height="106"/>
<line stroke="#d3d3d3" x1="186" y1="200" x2="336" y2="200"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="192" y="216">User</text>
<line stroke="#d3d3d3" x1="186" y1="222" x2="336" y2="222"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="192" y="238">ListFlightplans()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="192" y="254">SubmitFlightplan()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="192" y="270">Use()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="192" y="190">navstar.Passenger struct</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="406" y="174" width="120" height="106"/>
<line stroke="#d3d3d3" x1="406" y1="200" x2="526" y2="200"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="412" y="216">User</text>
<line stroke="#d3d3d3" x1="406" y1="222" x2="526" y2="222"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="412" y="238">ListFlightplans()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="412" y="254">SubmitFlightplan()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="412" y="270">Use()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="412" y="190">navstar.Crew struct</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="144" y="327">Different roles provide
		different methods</text></svg></div>
<p>We start of by defining all roles in one file together with the
	interface, showing partial content below. The reason being that
	roles change together, ie. if we define a new feature method, all
	roles need updating.</p>
<div class="filename"><a href="https:/github.com/gregoryv/navstar/blob/main/role.go">navstar/role.go</a></div>
<pre class="srcfile"><code class="go">type Role interface {
	SubmitFlightplan(route Flightplan) error
	ListFlightplans() ([]Flightplan, error)
	setUser(v *User)
}

// ----------------------------------------

type Pilot struct {
	*User
}

func (me *Pilot) SubmitFlightplan(v Flightplan) error {
	return me.submitFlightplan(v)
}

func (me *Pilot) ListFlightplans() ([]Flightplan, error) {
	return me.listFlightplans()
}

func (me *Pilot) setUser(v *User) {
	me.User = v
}
</code></pre><p>This design provides well defined places to implement future
	features. Assume the navstar service should provide planet
	information to users.</p>
<ol>
<li>Define resource Planet</li>
<li>Implement feature methods on type user, e.g.<ul>
<li><code>viewPlanet(name string)</code></li>
<li><code>savePlanet(v Planet) error</code></li>
</ul>
</li>
<li>Expose user methods to selected roles</li>
</ol>
<p>Note that authentication is not part of this design,
	i.e. translating some user credentials into one specific role. The
	reason is that authentication is not part of the navstar
	domain.</p>
<p>At this point the navstar system is fairly well designed and we
	know how to extend it with new features. It's time to expose the
	navstar system with an application through a HTTP interface.</p>
<h3>Application</h3>
<p>The navstar system needs to be exposed through an application
	that understands the HTTP protocol. We can use the same method to
	find a good name for the package holding the application. After
	some interations I ended up with</p>
<em>"Package htnav exposes the navstar system via HTTP"</em><p>The name htnav is just that, a name which is short, easy to
	pronounce and reads well when talking about the concepts it
	provides. As you can see in the tree layout there are two
	directories named htnav, this structure solves two things</p>
<p>The reason you shouldn't name it e.g. "navstar" is that the
	domain of navigating stars will grow and you probably want to
	expose parts of it differently, thus having multiple
	applications. Adding files for some of the mentioned abstractions
	we end up with a directory tree like this</p>
<pre class="command"><code>$ tree navstar
navstar
├── cmd
│   └── htnav
│       ├── application.go
│       └── htnav
│           └── main.go
├── package.go
├── resource.go
├── role.go
├── system.go
└── user.go

3 directories, 7 files
</code></pre><h2>HTTP interface</h2>
<p>The htnav application can now expose the navstar features
	using its system and roles. An application provides methods for
	accessing resources via different URLs. The routing of a url to a
	specific server method is handled by the subsequent router.</p>
<div class="filename"><a href="https:/github.com/gregoryv/navstar/blob/main/cmd/htnav/application.go">navstar/cmd/htnav/application.go</a></div>
<pre class="srcfile complete"><code class="go">// Package htnav exposes the navstar system via HTTP.
package htnav

import (
	"encoding/json"
	"net/http"

	"github.com/gregoryv/navstar"
)

func NewApplication(sys *navstar.System) *Application {
	return &Application{sys: sys}
}

type Application struct {
	sys *navstar.System
}

// Router returns a router providing HTTP access to the navstar
// system.
func (me *Application) Router() *http.ServeMux {
	m := http.NewServeMux()
	m.HandleFunc("/routes", me.serveRoutes)
	return m
}

func (me *Application) serveRoutes(w http.ResponseWriter, r *http.Request) {
	var role navstar.Role = getRole(r)
	var user navstar.User
	user.Use(me.sys, role)

	routes, _ := role.ListFlightplans()
	json.NewEncoder(w).Encode(routes)
}

// getRole returns a role implementation based on the incomming
// request. This one just looks for the query parameter role. Defaults
// to the passenger role.
func getRole(r *http.Request) navstar.Role {
	switch r.URL.Query().Get("role") {
	case "pilot":
		return &navstar.Pilot{}
	case "crew":
		return &navstar.Crew{}
	default:
		return &navstar.Passenger{}
	}
}
</code></pre><p>A request from a client such as a browser would follow the
	below sequence.</p>
<svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="626" height="428">
<rect stroke="black" stroke-width="0" fill="#ff9999" fill-opacity="0.1" x="362" y="24" width="220" height="350"/>
<text class="area-red-title" font-size="12px" x="368" y="42"></text>
<rect stroke="black" stroke-width="0" fill="#99e6ff" fill-opacity="0.1" x="252" y="24" width="110" height="350"/>
<text class="area-blue-title" font-size="12px" x="258" y="42"></text>
<line stroke="#d3d3d3" x1="32" y1="24" x2="32" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="10" y="18">browser</text>
<line stroke="#d3d3d3" x1="142" y1="24" x2="142" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="113" y="18">http.Server</text>
<line stroke="#d3d3d3" x1="252" y1="24" x2="252" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="205" y="18">htnav.Application</text>
<line stroke="#d3d3d3" x1="362" y1="24" x2="362" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="328" y="18">navstar.Role</text>
<text font-style="italic" font-family="Arial,Helvetica,sans-serif" font-size="12px" x="261" y="367">Protected by role</text>
<line stroke="#d3d3d3" x1="472" y1="24" x2="472" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="438" y="18">navstar.User</text>
<line stroke="#d3d3d3" x1="582" y1="24" x2="582" y2="332"/>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="541" y="18">navstar.System</text>
<text font-style="italic" font-family="Arial,Helvetica,sans-serif" font-size="12px" x="438" y="367">Unprotected</text>
<path stroke="black" d="M32,57 L142,57" />
<g transform="rotate(0 142 57)"><path stroke="black" fill="#ffffff" d="M142,57 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="55" y="54">GET /routes</text>
<path stroke="black" d="M142,90 L252,90" />
<g transform="rotate(0 252 90)"><path stroke="black" fill="#ffffff" d="M252,90 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="158" y="87">serveRoutes()</text>
<path stroke="black" d="M252,123 L362,123" />
<g transform="rotate(0 362 123)"><path stroke="black" fill="#ffffff" d="M362,123 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="282" y="120">new: role</text>
<path stroke="black" d="M252,156 L472,156" />
<g transform="rotate(0 472 156)"><path stroke="black" fill="#ffffff" d="M472,156 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="335" y="153">new: user</text>
<path stroke="black" d="M252,189 L472,189" />
<g transform="rotate(0 472 189)"><path stroke="black" fill="#ffffff" d="M472,189 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="314" y="186">Use(system, role)</text>
<path stroke="black" d="M252,222 L362,222" />
<g transform="rotate(0 362 222)"><path stroke="black" fill="#ffffff" d="M362,222 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="263" y="219">ListFlightplans()</text>
<path stroke="black" d="M362,255 L472,255" />
<g transform="rotate(0 472 255)"><path stroke="black" fill="#ffffff" d="M472,255 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="375" y="252">listFlightplans()</text>
<path stroke="black" d="M472,288 L582,288" />
<g transform="rotate(0 582 288)"><path stroke="black" fill="#ffffff" d="M582,288 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="484" y="285">query database</text>
<path stroke="black" d="M252,321 L32,321" />
<g transform="rotate(180 32 321)"><path stroke="black" fill="#ffffff" d="M32,321 l-8,-4 l 0,8 Z" /></g>

<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="91" y="318">write http response</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="198" y="421">Using navstar system via a HTTP interface</text></svg><p>Separating the domain logic from the application exposing it
	using some protocol allows your service to grow. Naming components
	carefully we can reason about concepts such as the-galaxytravel-service,
	navstar-system and htnav-application, which are all
	easily referencable in the source code aswell.</p>
</article>
<footer>Gregory Vin&ccaron;i&cacute;</footer></body>
</html>
