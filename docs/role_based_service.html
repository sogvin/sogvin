<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="theme.css"/>
<link rel="stylesheet" type="text/css" href="a4.css"/>
<title>Role based service - Software Engineering</title>
</head>
<body>
<header><code>Design - <a href="index.html">Software Engineering</a></code></header>
<article>
<h1>Role based service</h1>
<p>Servers provide a service through some protocol, often the
	protocol is HTTP. Services like this are often sizeable
	applications and without a design they become hard to maintain
	over time. Moreover services and their features need protecting
	from unauthorized access. One approach is to provide role based
	access.</p>
<div class="sidenote" style="margin-top: 2cm"><div class="inner">Use different nam- es for package, commands and DNS.</div>
</div>
<p>Let's assume we are writing a service for spaceflight. This
    service will be hosted on <code>galaxytravel.future.now</code>. The domain logic is <em>spaceflight</em> i.e. the package
    name. We'll name the application providing this service via HTTP, <em>htspace</em>.<br/>Don't name the application the same as
    the domain logic package. Also refrain from naming it same as the
    DNS name where it's hosted. The DNS will remain for a long time
    whereas your system will evolve, be split up into smaller
    applications with specific responsibilities. The domain logic
    however will probably remain the same. The directory layout looks
    like this</p>
<pre class="command"><code>$ tree spaceflight
spaceflight
├── cmd
│   └── htspace
│       ├── application.go
│       └── main.go
├── resource.go
├── role.go
└── system.go

2 directories, 5 files
</code></pre><p>The system is the most prominent abstraction the spaceflight
	package provides. It's responsible for synchronizing database
	access and other domain related configuration. There would usually
	only exist one instance of the system.</p>
<div class="filename">spaceflight/system.go</div>
<pre class="srcfile complete"><code class="go">package spaceflight

// System provides logic for reading and writing spaceflight related
// resources.
type System struct {
	// e.g. database, sync mutexes
}

// Use provides the given role access to the service.
func (me *System) Use(role Role) {
	var u user
	u.setSystem(me)
	role.setUser(&u)
}
</code></pre><p>Roles expose access to user methods. Fairly often we talk about
	what we can do with a system, referring to you and me as
	users.</p>
<em>- Pilots plan routes</em><br/><em>- Passengers and pilots view routes</em><p>This translates to PlanRoute is implemented by type user and
	accessible via the pilot role. Also ListRoutes is implemented by
	type user but accessible by both roles pilot and passenger.</p>
<div class="figure"><svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  font-family="Arial,Helvetica,sans-serif" width="395" height="264">
<path stroke="black" stroke-dasharray="5,5,5" d="M284,142 L220,72" />
<g transform="rotate(227 220 72)"><path stroke="black" fill="#ffffff" d="M220,72 l-8,-4 l 0,8 Z" /></g>

<path stroke="black" stroke-dasharray="5,5,5" d="M115,142 L175,72" />
<g transform="rotate(-49 175 72)"><path stroke="black" fill="#ffffff" d="M175,72 l-8,-4 l 0,8 Z" /></g>

<rect stroke="#d3d3d3" fill="#ffffff" x="120" y="20" width="154" height="52"/>
<line stroke="#d3d3d3" x1="120" y1="46" x2="274" y2="46"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="62">setUser()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="126" y="36">spaceflight.Role interface</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="20" y="142" width="134" height="68"/>
<line stroke="#d3d3d3" x1="20" y1="168" x2="154" y2="168"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="184">ListRoutes()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="200">PlanRoute()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="26" y="158">spaceflight.Pilot struct</text>
<rect stroke="#d3d3d3" fill="#ffffff" x="224" y="142" width="169" height="52"/>
<line stroke="#d3d3d3" x1="224" y1="168" x2="393" y2="168"/><text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="184">ListRoutes()</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="230" y="158">spaceflight.Passenger struct</text>
<text font-family="Arial,Helvetica,sans-serif" font-size="12px" x="78" y="257">Different roles provide
		different methods</text></svg></div>
<div class="filename">spaceflight/role.go</div>
<pre class="srcfile complete"><code class="go">package spaceflight

type Role interface {
	setUser(v *user)
}

type Pilot struct{ *user }

func (me *Pilot) setUser(v *user) { me.user = v }

type Passenger struct{ *user }

func (me *Passenger) setUser(v *user) { me.user = v }

// ----------------------------------------

// user implements domain logic for operations on the System and
// should be used through a role.
type user struct {
	sys *System
}

func (me *user) setSystem(v *System) { me.sys = v }

// ----------------------------------------

// PlanRoute stores the given route. Fails if route already exists.
func (me *Pilot) PlanRoute(v Route) error { return me.planRoute(v) }

func (me *user) planRoute(route Route) error {
	// implement...
	return nil
}

// ----------------------------------------

// ListRoutes returns all routes in the system.
func (me *Pilot) ListRoutes() []Route     { return me.listRoutes() }
func (me *Passenger) ListRoutes() []Route { return me.listRoutes() }

func (me *user) listRoutes() []Route {
	// implement list routes
	return nil
}
</code></pre><p>This design provides well defined places to implement future
	features. Assume the spaceflight service should provide planet
	information to users.</p>
<ol>
<li>Define resource Planet</li>
<li>Implement read write methods on type user, e.g.<ul>
<li><code>viewPlanet(name string)</code></li>
<li><code>savePlanet(v Planet) error</code></li>
</ul>
</li>
<li>Expose user methods to selected roles</li>
</ol>
<p>Once you need authentication you have the option to make it
	part of this service, by extending the Service.Use() method with
	e.g. credentials argument.</p>
<h2>HTTP interface</h2>
<p>The application htspace can now expose the spaceflight features
	using its system and roles. A server provides methods for
	accessing resources via different URLs. The routing of a url to a
	specific server method is handled by the subsequent router.</p>
<div class="filename">htspace/application.go</div>
<pre class="srcfile complete"><code class="go">package main

import (
	"encoding/json"
	"net/http"

	"github.com/gregoryv/sogvin/example/spaceflight"
)

func NewApplication(sys *spaceflight.System) *Application {
	return &Application{sys: sys}
}

type Application struct {
	sys *spaceflight.System
}

// Router returns a router providing HTTP access to the spaceflight
// system.
func (me *Application) Router() *http.ServeMux {
	m := http.NewServeMux()
	m.HandleFunc("/routes", me.serveRoutes)
	return m
}

func (me *Application) serveRoutes(w http.ResponseWriter, r *http.Request) {
	// Default to the passenger role
	var role spaceflight.Passenger
	me.sys.Use(&role)

	routes := role.ListRoutes()
	json.NewEncoder(w).Encode(routes)
}
</code></pre></article>
<footer>Gregory Vin&ccaron;i&cacute;</footer></body>
</html>
